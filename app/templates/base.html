<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}معهد القاسم للعلوم واللغات{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('public.index') }}">
                <i class="fas fa-graduation-cap ms-2"></i>
                {% if settings %}{{ settings.institute_name }}{% else %}معهد القاسم{% endif %}
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('public.index') }}">الرئيسية</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('public.courses') }}">الدورات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('public.teachers') }}">المدرسون</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('public.news') }}">الأخبار</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('public.contact') }}">اتصل بنا</a>
                    </li>
                    {% if current_user.is_authenticated %}
                        {% if current_user.role in ['admin', 'assistant'] %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.dashboard') }}">
                                    <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                                </a>
                            </li>
                        {% elif current_user.role == 'teacher' %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('teacher.dashboard') }}">
                                    <i class="fas fa-chalkboard-teacher"></i> لوحتي
                                </a>
                            </li>
                        {% elif current_user.role == 'student' %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('student.dashboard') }}">
                                    <i class="fas fa-user-graduate"></i> لوحتي
                                </a>
                            </li>
                        {% endif %}
                        {% if current_user.role in ['student', 'teacher'] %}
                            <li class="nav-item">
                                <a class="nav-link position-relative" href="{% if current_user.role == 'student' %}{{ url_for('student.notifications') }}{% else %}{{ url_for('teacher.notifications') }}{% endif %}">
                                    <i class="fas fa-bell"></i>
                                    {% set unread_count = current_user.get_unread_notifications_count() %}
                                    {% if unread_count > 0 %}
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                                        {{ unread_count if unread_count < 100 else '99+' }}
                                    </span>
                                    {% endif %}
                                </a>
                            </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.logout') }}">
                                <i class="fas fa-sign-out-alt"></i> خروج
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('auth.login') }}">
                                <i class="fas fa-sign-in-alt"></i> دخول
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <main>
        {% block content %}{% endblock %}
    </main>

    {% if current_user.is_authenticated and current_user.role in ['student', 'teacher'] %}
    <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="notificationsModalLabel">
                        <i class="fas fa-bell ms-2"></i> إشعارات جديدة
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationsModalBody">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{% if current_user.role == 'student' %}{{ url_for('student.notifications') }}{% else %}{{ url_for('teacher.notifications') }}{% endif %}" class="btn btn-primary">
                        عرض جميع الإشعارات
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>عن المعهد</h5>
                    <p>{% if settings %}{{ settings.mission_statement }}{% else %}معهد تعليمي رائد{% endif %}</p>
                </div>
                <div class="col-md-4">
                    <h5>تواصل معنا</h5>
                    <ul class="list-unstyled">
                        {% if settings %}
                            {% if settings.phone1 %}<li><i class="fas fa-phone"></i> {{ settings.phone1 }}</li>{% endif %}
                            {% if settings.email %}<li><i class="fas fa-envelope"></i> {{ settings.email }}</li>{% endif %}
                        {% endif %}
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>تابعنا</h5>
                    {% if settings and settings.facebook_url %}
                        <a href="{{ settings.facebook_url }}" class="text-white ms-3" target="_blank">
                            <i class="fab fa-facebook fa-2x"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
            <hr class="bg-white">
            <div class="text-center">
                <p>&copy; 2024 معهد القاسم للعلوم واللغات. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if current_user.is_authenticated and current_user.role in ['student', 'teacher'] %}
    <script>
        let lastNotificationCheck = 0;
        let previousUnreadCount = {{ current_user.get_unread_notifications_count() }};
        let notificationCheckInterval = null;
        let hasShownPopup = false;
        
        function getNotificationsApiUrl() {
            {% if current_user.role == 'student' %}
            return '{{ url_for("student.api_get_unread_notifications") }}';
            {% else %}
            return '{{ url_for("teacher.api_get_unread_notifications") }}';
            {% endif %}
        }
        
        function getMarkReadApiUrl(recipientId) {
            {% if current_user.role == 'student' %}
            return '{{ url_for("student.api_mark_notification_read", recipient_id=0) }}'.replace('0', recipientId);
            {% else %}
            return '{{ url_for("teacher.api_mark_notification_read", recipient_id=0) }}'.replace('0', recipientId);
            {% endif %}
        }
        
        function updateBadge(count) {
            const badge = document.querySelector('.nav-link .badge');
            const bellIcon = document.querySelector('.nav-link .fa-bell');
            
            if (count > 0) {
                if (badge) {
                    badge.textContent = count < 100 ? count : '99+';
                } else if (bellIcon) {
                    const newBadge = document.createElement('span');
                    newBadge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                    newBadge.style.fontSize = '0.6rem';
                    newBadge.textContent = count < 100 ? count : '99+';
                    bellIcon.parentElement.classList.add('position-relative');
                    bellIcon.parentElement.appendChild(newBadge);
                }
            } else {
                if (badge) {
                    badge.remove();
                }
            }
        }
        
        function checkForNewNotifications() {
            fetch(getNotificationsApiUrl())
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        updateBadge(data.count);
                        
                        if (data.count > previousUnreadCount && data.count > 0 && !hasShownPopup) {
                            showNotificationPopup(data.notifications);
                            hasShownPopup = true;
                            setTimeout(() => { hasShownPopup = false; }, 300000);
                        }
                        
                        previousUnreadCount = data.count;
                    } else {
                        console.error('فشل في جلب الإشعارات:', data.error);
                    }
                })
                .catch(error => {
                    console.error('خطأ في التحقق من الإشعارات:', error);
                });
        }
        
        function showNotificationPopup(notifications) {
            const modalBody = document.getElementById('notificationsModalBody');
            
            if (notifications.length === 0) {
                modalBody.innerHTML = '<div class="alert alert-info">لا توجد إشعارات جديدة</div>';
                return;
            }
            
            let html = '<div class="list-group">';
            
            notifications.forEach(notif => {
                let badgeClass = 'bg-secondary';
                let badgeText = 'عام';
                
                if (notif.type === 'new_lesson') {
                    badgeClass = 'bg-primary';
                    badgeText = 'درس جديد';
                } else if (notif.type === 'new_grade') {
                    badgeClass = 'bg-success';
                    badgeText = 'علامة جديدة';
                } else if (notif.type === 'updated_grade') {
                    badgeClass = 'bg-warning';
                    badgeText = 'تحديث علامة';
                }
                
                const message = notif.message || '';
                const messagePreview = message.length > 100 
                    ? message.substring(0, 100) + '...' 
                    : message;
                
                html += `
                    <div class="list-group-item" id="notification-${notif.id}">
                        <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">
                                <i class="fas fa-circle text-primary" style="font-size: 0.5rem;"></i>
                                ${notif.title}
                            </h6>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <p class="mb-2" style="white-space: pre-wrap;">${messagePreview}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${notif.created_at}
                            </small>
                            <button class="btn btn-sm btn-outline-primary" onclick="markAsRead(${notif.id})">
                                <i class="fas fa-check"></i> تحديد كمقروء
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            modalBody.innerHTML = html;
            
            const modal = new bootstrap.Modal(document.getElementById('notificationsModal'));
            modal.show();
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        function markAsRead(recipientId) {
            fetch(getMarkReadApiUrl(recipientId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notifElement = document.getElementById(`notification-${recipientId}`);
                    if (notifElement) {
                        notifElement.style.opacity = '0.5';
                        notifElement.querySelector('.btn').disabled = true;
                        notifElement.querySelector('.btn').innerHTML = '<i class="fas fa-check-circle"></i> تم القراءة';
                    }
                    
                    checkForNewNotifications();
                }
            })
            .catch(error => {
                console.error('خطأ في تحديد الإشعار كمقروء:', error);
            });
        }
        
        checkForNewNotifications();
        
        notificationCheckInterval = setInterval(checkForNewNotifications, 30000);
        
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                checkForNewNotifications();
            }
        });
    </script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
</body>
</html>
