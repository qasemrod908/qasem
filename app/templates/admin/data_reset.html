{% extends "base.html" %}

{% block title %}تصفير البيانات - معهد القاسم{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">
        <i class="fas fa-trash-restore ms-2"></i>
        تصفير البيانات
    </h2>

    <div class="alert alert-danger border-danger shadow-sm">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-3x ms-3"></i>
            <div>
                <h4 class="alert-heading mb-2">⚠️ تحذير شديد الأهمية!</h4>
                <p class="mb-2">هذه الصفحة تتيح لك <strong>حذف البيانات بشكل دائم</strong> من قاعدة البيانات.</p>
                <ul class="mb-0">
                    <li>العملية <strong class="text-decoration-underline">غير قابلة للتراجع</strong></li>
                    <li>يُنصح بشدة بإنشاء <a href="{{ url_for('admin.backup') }}" class="alert-link">نسخة احتياطية</a> قبل المتابعة</li>
                    <li>استخدم هذه الميزة بحذر شديد</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-cog ms-2"></i>
                خيارات التصفير
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin.data_reset') }}" id="resetForm">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="mb-3 text-primary">
                            <i class="fas fa-check-square ms-2"></i>
                            اختر البيانات المراد حذفها:
                        </h6>
                        
                        <div class="form-check mb-3 p-3 bg-light rounded">
                            <input class="form-check-input" type="checkbox" name="reset_all" id="reset_all">
                            <label class="form-check-label fw-bold text-danger" for="reset_all">
                                <i class="fas fa-exclamation-circle ms-2"></i>
                                حذف شامل لجميع البيانات
                            </label>
                            <small class="d-block text-muted mt-1">سيتم حذف كل البيانات أدناه دفعة واحدة</small>
                        </div>

                        <hr>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_students" id="reset_students">
                            <label class="form-check-label" for="reset_students">
                                <i class="fas fa-user-graduate ms-2"></i>
                                حذف سجلات الطلاب
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_teachers" id="reset_teachers">
                            <label class="form-check-label" for="reset_teachers">
                                <i class="fas fa-chalkboard-teacher ms-2"></i>
                                حذف سجلات الأساتذة
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_courses" id="reset_courses">
                            <label class="form-check-label" for="reset_courses">
                                <i class="fas fa-book ms-2"></i>
                                حذف الدورات
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_lessons" id="reset_lessons">
                            <label class="form-check-label" for="reset_lessons">
                                <i class="fas fa-file-alt ms-2"></i>
                                حذف الدروس
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_grades" id="reset_grades">
                            <label class="form-check-label" for="reset_grades">
                                <i class="fas fa-chart-line ms-2"></i>
                                حذف العلامات
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_payments" id="reset_payments">
                            <label class="form-check-label" for="reset_payments">
                                <i class="fas fa-money-bill-wave ms-2"></i>
                                حذف الأقساط والدفعات
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_enrollments" id="reset_enrollments">
                            <label class="form-check-label" for="reset_enrollments">
                                <i class="fas fa-user-check ms-2"></i>
                                حذف التسجيلات
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_grades_data" id="reset_grades_data">
                            <label class="form-check-label" for="reset_grades_data">
                                <i class="fas fa-graduation-cap ms-2"></i>
                                حذف الصفوف الدراسية
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_sections" id="reset_sections">
                            <label class="form-check-label" for="reset_sections">
                                <i class="fas fa-layer-group ms-2"></i>
                                حذف الشعب
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_news" id="reset_news">
                            <label class="form-check-label" for="reset_news">
                                <i class="fas fa-newspaper ms-2"></i>
                                حذف الأخبار
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_notifications" id="reset_notifications">
                            <label class="form-check-label" for="reset_notifications">
                                <i class="fas fa-bell ms-2"></i>
                                حذف الإشعارات
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_attendance" id="reset_attendance">
                            <label class="form-check-label" for="reset_attendance">
                                <i class="fas fa-clipboard-check ms-2"></i>
                                حذف سجلات الحضور والغياب
                            </label>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input reset-option" type="checkbox" name="reset_contacts" id="reset_contacts">
                            <label class="form-check-label" for="reset_contacts">
                                <i class="fas fa-envelope ms-2"></i>
                                حذف رسائل اتصل بنا
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle ms-2"></i>
                                    معلومات مهمة
                                </h6>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary">📌 قبل البدء:</h6>
                                <ul class="small mb-3">
                                    <li>تأكد من إنشاء نسخة احتياطية</li>
                                    <li>تحقق من اختياراتك بعناية</li>
                                    <li>لا يمكن التراجع عن الحذف</li>
                                </ul>

                                <h6 class="text-danger">⚠️ الحذف الشامل:</h6>
                                <ul class="small mb-3">
                                    <li>يحذف جميع البيانات المحددة أدناه</li>
                                    <li>استخدمه فقط عند الضرورة القصوى</li>
                                    <li>سيتطلب تأكيد مزدوج</li>
                                </ul>

                                <h6 class="text-success">✅ ما لن يتم حذفه:</h6>
                                <ul class="small mb-0">
                                    <li>حسابات المديرين والمعاونين</li>
                                    <li>إعدادات النظام</li>
                                    <li>النسخ الاحتياطية السابقة</li>
                                </ul>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-lightbulb ms-2"></i> نصيحة:</h6>
                            <p class="mb-0 small">يمكنك اختيار عدة خيارات في نفس الوقت. سيتم حذف البيانات بالترتيب الصحيح لتجنب مشاكل الارتباطات.</p>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-right ms-2"></i>
                        إلغاء والعودة
                    </a>
                    <button type="submit" class="btn btn-danger btn-lg" id="submitBtn">
                        <i class="fas fa-trash-alt ms-2"></i>
                        تنفيذ عملية الحذف
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Script for "حذف شامل" checkbox
document.getElementById('reset_all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.reset-option');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Uncheck "حذف شامل" if any individual option is unchecked
document.querySelectorAll('.reset-option').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const allChecked = Array.from(document.querySelectorAll('.reset-option')).every(cb => cb.checked);
        document.getElementById('reset_all').checked = allChecked;
    });
});

// Form submission confirmation
document.getElementById('resetForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
    
    if (checkedBoxes.length === 0) {
        alert('⚠️ يرجى اختيار عنصر واحد على الأقل للحذف');
        return false;
    }
    
    const resetAll = document.getElementById('reset_all').checked;
    let confirmMessage = '';
    
    if (resetAll) {
        confirmMessage = '🔴 تحذير: أنت على وشك حذف جميع البيانات!\n\n';
        confirmMessage += 'هذه العملية ستحذف كل شيء ولا يمكن التراجع عنها.\n\n';
        confirmMessage += 'هل أنت متأكد تماماً من المتابعة؟';
        
        if (!confirm(confirmMessage)) {
            return false;
        }
        
        // Double confirmation for complete reset
        const doubleConfirm = prompt('للتأكيد، يرجى كتابة "حذف" في المربع أدناه:');
        if (doubleConfirm !== 'حذف') {
            alert('تم إلغاء العملية');
            return false;
        }
    } else {
        const selectedItems = [];
        checkedBoxes.forEach(box => {
            const label = document.querySelector(`label[for="${box.id}"]`);
            if (label && box.id !== 'reset_all') {
                selectedItems.push(label.textContent.trim());
            }
        });
        
        confirmMessage = '⚠️ أنت على وشك حذف البيانات التالية:\n\n';
        confirmMessage += selectedItems.join('\n');
        confirmMessage += '\n\nهذه العملية لا يمكن التراجع عنها.\n\n';
        confirmMessage += 'هل أنت متأكد من المتابعة؟';
        
        if (!confirm(confirmMessage)) {
            return false;
        }
    }
    
    this.submit();
});
</script>

<style>
.form-check-input:checked {
    background-color: #dc3545;
    border-color: #dc3545;
}

.form-check-label {
    cursor: pointer;
    user-select: none;
}

.form-check:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    transition: background-color 0.2s;
}

#reset_all:checked ~ label {
    color: #dc3545;
    font-weight: bold;
}
</style>
{% endblock %}
