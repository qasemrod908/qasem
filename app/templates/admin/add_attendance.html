{% extends "base.html" %}

{% block title %}ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ - Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ù‚Ø§Ø³Ù…{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-check ms-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.add_attendance') }}" id="attendanceForm">
                        <div class="mb-3">
                            <label for="user_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span class="text-danger">*</span></label>
                            <select class="form-select" id="user_type" name="user_type" required onchange="updateUserList()">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹...</option>
                                <option value="student">Ø·Ø§Ù„Ø¨</option>
                                <option value="teacher">Ø£Ø³ØªØ§Ø°</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† <span class="text-danger">*</span></label>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." onkeyup="filterUsers()">
                            </div>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    <label class="form-check-label fw-bold" for="selectAll">
                                        ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                                    </label>
                                </div>
                                <hr>
                                <div id="usersList"></div>
                            </div>
                            <small class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†: <span id="selectedCount" class="fw-bold">0</span></small>
                        </div>

                        <div class="mb-3">
                            <label for="date" class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ® <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ today }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="status" class="form-label">Ø§Ù„Ø­Ø§Ù„Ø© <span class="text-danger">*</span></label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©...</option>
                                <option value="present">Ø­Ø¶ÙˆØ±</option>
                                <option value="absent">ØºÙŠØ§Ø¨</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø«Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save ms-2"></i>Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
                            </button>
                            <a href="{{ url_for('admin.attendance_list') }}" class="btn btn-secondary">
                                <i class="fas fa-times ms-2"></i>Ø¥Ù„ØºØ§Ø¡
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const students = {{ students|tojson }};
    const teachers = {{ teachers|tojson }};
    let currentUsers = [];

    function updateUserList() {
        const userType = document.getElementById('user_type').value;
        const usersList = document.getElementById('usersList');
        const selectAll = document.getElementById('selectAll');
        
        usersList.innerHTML = '';
        selectAll.checked = false;
        
        if (userType === 'student') {
            currentUsers = students;
        } else if (userType === 'teacher') {
            currentUsers = teachers;
        } else {
            currentUsers = [];
        }
        
        renderUsers(currentUsers);
        updateSelectedCount();
    }

    function renderUsers(users) {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';
        
        if (users.length === 0) {
            usersList.innerHTML = '<p class="text-muted text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>';
            return;
        }
        
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2 user-item';
            div.setAttribute('data-name', user.full_name.toLowerCase());
            div.setAttribute('data-number', (user.student_number || user.specialization || '').toLowerCase());
            
            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input user-checkbox';
            checkbox.type = 'checkbox';
            checkbox.name = 'user_ids[]';
            checkbox.value = user.user_id;
            checkbox.id = 'user_' + user.user_id;
            checkbox.onchange = updateSelectedCount;
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = 'user_' + user.user_id;
            
            if (user.student_number) {
                label.textContent = user.full_name + ' (' + user.student_number + ')';
            } else if (user.specialization) {
                label.textContent = user.full_name + ' - ' + user.specialization;
            } else {
                label.textContent = user.full_name;
            }
            
            div.appendChild(checkbox);
            div.appendChild(label);
            usersList.appendChild(div);
        });
    }

    function filterUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const userItems = document.querySelectorAll('.user-item');
        
        userItems.forEach(item => {
            const name = item.getAttribute('data-name');
            const number = item.getAttribute('data-number');
            
            if (name.includes(searchTerm) || number.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.user-checkbox');
        const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
            return cb.closest('.user-item').style.display !== 'none';
        });
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        document.getElementById('selectedCount').textContent = checkboxes.length;
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            return false;
        }
    });
</script>
{% endblock %}
