{% extends "base.html" %}

{% block title %}تسجيل حضور/غياب - معهد القاسم{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-check ms-2"></i>
                        تسجيل حضور/غياب جديد
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.add_attendance') }}" id="attendanceForm">
                        <div class="mb-3">
                            <label for="user_type" class="form-label">نوع المستخدم <span class="text-danger">*</span></label>
                            <select class="form-select" id="user_type" name="user_type" required onchange="updateUserList()">
                                <option value="">اختر النوع...</option>
                                <option value="student">طالب</option>
                                <option value="teacher">أستاذ</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">اختر المستخدمين <span class="text-danger">*</span></label>
                            <div class="mb-2">
                                <input type="text" class="form-control" id="searchInput" placeholder="🔍 ابحث عن مستخدم..." onkeyup="filterUsers()">
                            </div>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    <label class="form-check-label fw-bold" for="selectAll">
                                        تحديد الكل / إلغاء التحديد
                                    </label>
                                </div>
                                <hr>
                                <div id="usersList"></div>
                            </div>
                            <small class="text-muted">عدد المستخدمين المحددين: <span id="selectedCount" class="fw-bold">0</span></small>
                        </div>

                        <div class="mb-3">
                            <label for="date" class="form-label">التاريخ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ today }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="status" class="form-label">الحالة <span class="text-danger">*</span></label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="">اختر الحالة...</option>
                                <option value="present">حضور</option>
                                <option value="absent">غياب</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">ملاحظات (اختياري)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="يمكنك إضافة ملاحظات مثل سبب الغياب أو معلومات إضافية..."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save ms-2"></i>حفظ السجلات
                            </button>
                            <a href="{{ url_for('admin.attendance_list') }}" class="btn btn-secondary">
                                <i class="fas fa-times ms-2"></i>إلغاء
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const students = {{ students|tojson }};
    const teachers = {{ teachers|tojson }};
    let currentUsers = [];

    function updateUserList() {
        const userType = document.getElementById('user_type').value;
        const usersList = document.getElementById('usersList');
        const selectAll = document.getElementById('selectAll');
        
        usersList.innerHTML = '';
        selectAll.checked = false;
        
        if (userType === 'student') {
            currentUsers = students;
        } else if (userType === 'teacher') {
            currentUsers = teachers;
        } else {
            currentUsers = [];
        }
        
        renderUsers(currentUsers);
        updateSelectedCount();
    }

    function renderUsers(users) {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';
        
        if (users.length === 0) {
            usersList.innerHTML = '<p class="text-muted text-center">لا يوجد مستخدمين</p>';
            return;
        }
        
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2 user-item';
            div.setAttribute('data-name', user.full_name.toLowerCase());
            div.setAttribute('data-number', (user.student_number || user.specialization || '').toLowerCase());
            
            const checkbox = document.createElement('input');
            checkbox.className = 'form-check-input user-checkbox';
            checkbox.type = 'checkbox';
            checkbox.name = 'user_ids[]';
            checkbox.value = user.user_id;
            checkbox.id = 'user_' + user.user_id;
            checkbox.onchange = updateSelectedCount;
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = 'user_' + user.user_id;
            
            if (user.student_number) {
                label.textContent = user.full_name + ' (' + user.student_number + ')';
            } else if (user.specialization) {
                label.textContent = user.full_name + ' - ' + user.specialization;
            } else {
                label.textContent = user.full_name;
            }
            
            div.appendChild(checkbox);
            div.appendChild(label);
            usersList.appendChild(div);
        });
    }

    function filterUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const userItems = document.querySelectorAll('.user-item');
        
        userItems.forEach(item => {
            const name = item.getAttribute('data-name');
            const number = item.getAttribute('data-number');
            
            if (name.includes(searchTerm) || number.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.user-checkbox');
        const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
            return cb.closest('.user-item').style.display !== 'none';
        });
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        document.getElementById('selectedCount').textContent = checkboxes.length;
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert('يرجى تحديد مستخدم واحد على الأقل');
            return false;
        }
    });
</script>
{% endblock %}
