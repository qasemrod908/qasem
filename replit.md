# تطبيق معهد القاسم للعلوم واللغات

## Overview
تطبيق ويب شامل لإدارة معهد تعليمي باللغة العربية، مبني باستخدام Flask وPython وقاعدة بيانات SQLite. يوفر نظامًا متكاملًا لإدارة المستخدمين، الدورات التدريبية، الأخبار، والدروس، مع نظام مصادقة متعدد الأدوار ونظام نسخ احتياطي متقدم يدعم التكامل مع Telegram. يهدف المشروع إلى توفير حل شامل لإدارة العمليات التعليمية والإدارية للمعهد، مع التركيز على الأمان وسهولة الاستخدام.

## User Preferences
- جميع الاتصالات باللغة العربية
- شرح واضح ومختصر
- الإبلاغ عن التغييرات المهمة قبل تنفيذها
- إعطاء الأولوية للأمان وسلامة البيانات
- عدم استخدام بيانات ثابتة في الكود

## System Architecture

### التقنيات المستخدمة
-   **الواجهة الخلفية**: Flask (Python 3.11)
-   **قاعدة البيانات**: SQLite
-   **المصادقة**: Flask-Login مع تسجيل دخول برقم الجوال وتشفير كلمات المرور
-   **النماذج**: Flask-WTF مع حماية CSRF

### الميزات الرئيسية
-   **نظام الصلاحيات الشامل**: نظام صلاحيات متقدم ومفصل مع أكثر من 80 صلاحية موزعة على 17 فئة. يمكن للمدير الرئيسي منح/إلغاء صلاحيات محددة لكل مستخدم، نسخ الصلاحيات، وإعادة تعيين الصلاحيات الافتراضية.
-   **إدارة المستخدمين والأدوار**: دعم أربعة أدوار (مدير، معاون، مدرس، طالب) مع صلاحيات متقدمة.
-   **إدارة الطلاب والأساتذة**: عرض، تعديل، حذف، تسجيل الطلاب في دورات، وربطهم بأساتذة، مع تحديد الصف والشعبة. يتضمن نظام بحث وفلترة احترافي.
-   **إدارة الصفوف والشعب**: نظام متكامل لإدارة الصفوف الدراسية والشعب مع إحصائيات شاملة (طلاب، مقاعد، حضور، مالية).
-   **إدارة الدورات**: إضافة، تعديل، حذف الدورات مع رفع الصور وتحديد التفاصيل.
-   **إدارة الدروس**: إضافة، تعديل، حذف الدروس، تحديد الدورة والأستاذ، ورفع الملفات، متاحة للطلاب المسجلين.
-   **نظام العلامات**: إدارة العلامات من قبل المدرسين، وإدارة كاملة للمدراء والمعاونين.
-   **نظام الأقساط والدفعات**: إدارة شاملة للأقساط والدفعات، تتبع الحالة، بحث وفلترة متقدم، تقارير مالية ورسوم بيانية، إشعارات تلقائية وتذكير بالأقساط المتأخرة.
-   **نظام الإشعارات**: إرسال إشعارات عبر Telegram والموقع، إشعارات تلقائية، تتبع حالة القراءة والتسليم، نظام فلترة متقدم، وعمليات جماعية.
-   **نظام الحضور والغياب**: تسجيل حضور جماعي، عرض منظم للسجلات، فلترة متقدمة، وإحصائيات تفصيلية.
-   **بوت تيليجرام متكامل**: بوت احترافي للمستخدمين يوفر تسجيل دخول، عرض دورات ودروس ودرجات وأخبار، مع لوحة تحكم مخصصة وإشعارات تلقائية.
-   **التصدير إلى Excel**: نظام شامل لتصدير البيانات إلى ملفات Excel مع تنسيق احترافي ودعم RTL لسجلات الحضور، الطلاب، الأساتذة، والأقساط.
-   **نظام تصفير البيانات**: نظام آمن لحذف البيانات من قاعدة البيانات بشكل انتقائي أو شامل مع منطق cascade تلقائي.
-   **نظام إدارة الملفات الشخصية**: صفحات عرض وتعديل الملف الشخصي للطلاب والأساتذة مع إدارة متقدمة للجلسات (session_version) وحماية ضد session fixation.

### هيكل المشروع
يتكون المشروع من مجلد `app/` الذي يحتوي على النماذج (models)، المسارات (routes) للمصادقة، الإدارة، المدرسين، الطلاب، والصفحات العامة، بالإضافة إلى القوالب (templates)، الملفات الثابتة (static)، والأدوات المساعدة (utils).

## External Dependencies
-   **Telegram Bot API**: للتكامل مع Telegram لإرسال إشعارات النسخ الاحتياطي التلقائية، استلام رسائل "اتصل بنا"، وتشغيل بوت التيليجرام التفاعلي للمستخدمين.

## Recent Changes

### تحسينات نظام الصلاحيات والمدير الرئيسي (27 أكتوبر 2025)
تم إضافة نظام صلاحيات متقدم وشامل مع تحديد المدير الرئيسي (Super Admin):

**الإضافات الرئيسية:**
- ملف تكوين شامل يحتوي على أكثر من 80 صلاحية موزعة على 17 فئة
- decorators جديدة للصلاحيات: `any_permission_required`, `all_permissions_required`, `role_or_permission_required`
- واجهة مرئية لإدارة الصلاحيات مع ميزات متقدمة (منح/إلغاء، نسخ، إعادة تعيين)
- صلاحيات افتراضية محددة لكل دور يتم تطبيقها تلقائياً على المستخدمين الجدد
- سكريبت مساعد لتطبيق الصلاحيات على المستخدمين الحاليين
- دليل شامل في `PERMISSIONS_GUIDE.md`

**تحديثات المدير الرئيسي (Super Admin):**
- إضافة دالة `is_super_admin()` في User model لتحديد المدير الرئيسي (0938074766)
- إخفاء زر "إدارة الصلاحيات" عن غير المدير الرئيسي إلا إذا تم منحهم صلاحية `users.manage_permissions`
- عرض جميع المستخدمين (بما فيهم المدراء والمعاونين) في صفحة إدارة الصلاحيات للمدير الرئيسي
- إخفاء المدير الرئيسي عن بقية المدراء في صفحة إدارة الصلاحيات
- منع المدراء العاديين من تعديل صلاحيات المدير الرئيسي أو المدراء الآخرين
- إصلاح خطأ Internal Server Error في صفحة تعديل الصلاحيات